---
- name: install taps
  homebrew_tap: tap={{ item }} state=present
  with_items:
    - homebrew/cask
    - homebrew/cask-fonts

- name: install brews
  homebrew: name={{ item }} state=present
  ignore_errors: yes
  with_items:
    - composer
    - git
    - openjdk
    - python
    - mas
    - maven
    - node
    - svn
    - rbenv
    - ruby
    - wget
    - mysql-client@5.7

- name: install Memcached
  homebrew: name=memcached state=present
  notify: restart memcached

- name: install MariaDB
  homebrew: name=mariadb@10.3 state=present
  notify: restart mariadb

- name: install Redis
  homebrew: name=redis state=present
  notify: restart redis

- name: get installed apps from app store
  command: mas list
  when: not lookup("env", "CI")
  register: mas_result
  check_mode: no
  changed_when: false

- name: install apps from app store
  command: mas install {{ item }}
  ignore_errors: yes
  when: not mas_result.skipped|default(false) and item|string not in mas_result.stdout
  with_items: '{{ app_store_apps }}'

- name: install casks
  homebrew_cask: name={{ item }} state=present
  when: not lookup("env", "CI")
  ignore_errors: yes
  with_items: '{{ cask_apps }}'

- name: install pip packages
  pip: name={{ item }} state=present
  with_items:
    - ansible
    - mysqlclient
    - PyMySQL
    - python-memcached
    - virtualenv
  environment:
    PATH: "/usr/local/opt/mariadb@10.3/bin:{{ ansible_env.PATH }}"

- name: install npm packages
  npm: name={{ item }} global=yes state=present
  with_items:
    - bower

- name: install gem packages
  gem: name={{ item }} state=present
  with_items:
    - sass
    - bundler

- name: symlink JDK for system Java wrappers
  file: src=/opt/homebrew/opt/openjdk/libexec/openjdk.jdk dest=/Library/Java/JavaVirtualMachines/openjdk.jdk state=link follow=no
  when: not lookup("env", "CI")
  become: yes
